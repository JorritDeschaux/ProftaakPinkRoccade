@model PinkRoccade.BS.Models.IncidentModel
@using Microsoft.AspNetCore.Http;
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@addTagHelper *, DNTCaptcha.Core


@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutMap.cshtml";
}


@section header {

    <!-- leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>

    <!-- Proj4 and Proj4Leaflet -->
    <script src="https://unpkg.com/proj4@2.5.0/dist/proj4-src.js"></script>
    <script src="https://unpkg.com/proj4leaflet@1.0.1"></script>
    <style>
        html, body {
            height: 100%;
        }
    </style>
}

<div id="sm-alert" class="alert alert-primary alert-dismissible fade show mb-0 p-2" style="display: none;">
    <h5>Druk op de kaart om een melding te maken!</h5>
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
</div>
<div class="row h-100 m-auto">
    <div class="col-lg-4 col-md-5 col-6 d-none d-md-block">
        <h2>Maak een melding</h2>
        <form asp-action="CreateIncident" enctype="multipart/form-data" asp-controller="Incidents" asp-antiforgery="true" method="post">
            <div class="form-group">
                <label for="location">Locatie</label>
                <textarea class="form-control" type="text" name="Location" id="location" readonly></textarea>
            </div>
            @{
                if (Html.ViewContext.HttpContext.Session.GetInt32("LoggedIn") != 1)
                {
                    <div class="form-group">
                        @Html.LabelFor(model => model.Email, htmlAttributes: new { })
                        <input class="form-control" name="Email" required />
                        @Html.ValidationMessageFor(model => model.Email, "", new { @class = "text-danger" })
                    </div>
                }
            }
            <div class="form-group">
                <label for="description">Beschrijving</label>
                <textarea class="form-control" name="Description" id="description" cols="30" rows="5"></textarea>
            </div>
            <div class="form-group">
                <label for="img">Bijlage</label>
                <input class="form-control-file" type="file" name="img" id="img">
            </div>

            <div class="input-group mb-3">
                <dnt-captcha asp-captcha-generator-max="999"
                             asp-captcha-generator-min="111"
                             asp-captcha-generator-language="English"
                             asp-captcha-generator-display-mode="ShowDigits"
                             asp-use-relative-urls="true"
                             asp-placeholder="Vul beveiligingscode in."
                             asp-validation-error-message="Vul de juiste code in."
                             asp-font-name="Tahoma"
                             asp-font-size="20"
                             asp-fore-color="#333333"
                             asp-back-color="#ccc"
                             asp-text-box-class="text-box form-control"
                             asp-text-box-template="<span class='input-group-prepend'><span class='form-group-text'></span></span>{0}"
                             asp-validation-message-class="text-danger"
                             asp-refresh-button-class="fas fa-redo btn-sm"
                             asp-use-noise="false" />
            </div>

            <input id="lat" type="hidden" name="Latitude">
            <input id="lng" type="hidden" name="Longitude">
            <button class="btn btn-primary" type="submit">Verzenden</button>
        </form>
    </div>
    <div class="col p-0">
        <div id="mapid" style="width:auto; height:100%;"></div>
    </div>
</div>

<div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Maak een melding</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form asp-action="CreateIncident" enctype="multipart/form-data" asp-controller="Incidents" asp-antiforgery="true" method="post">
                    <div class="form-group">
                        <label for="location">Locatie</label>
                        <textarea class="form-control" type="text" name="Location" id="sm-location" readonly></textarea>
                    </div>
                    @if (Html.ViewContext.HttpContext.Session.GetInt32("LoggedIn") != 1)
                    {
                        <div class="form-group">
                            @Html.LabelFor(model => model.Email, htmlAttributes: new {  })
                            <input class="form-control" name="Email" required/>
                            @Html.ValidationMessageFor(model => model.Email, "", new { @class = "text-danger" })
                        </div>
                    }
                    <div class="form-group">
                        <label for="description">Beschrijving</label>
                        <textarea class="form-control" name="Description" id="sm-description" cols="30" rows="10"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="img">Invoer</label>
                        <input class="form-control-file" type="file" name="img" id="img">
                    </div>
                    <div class="input-group mb-3">
                        <dnt-captcha asp-captcha-generator-max="999"
                                     asp-captcha-generator-min="111"
                                     asp-captcha-generator-language="English"
                                     asp-captcha-generator-display-mode="ShowDigits"
                                     asp-use-relative-urls="true"
                                     asp-placeholder="Vul beveiligingscode in."
                                     asp-validation-error-message="Vul de juiste code in."
                                     asp-font-name="Tahoma"
                                     asp-font-size="20"
                                     asp-fore-color="#333333"
                                     asp-back-color="#ccc"
                                     asp-text-box-class="text-box form-control"
                                     asp-text-box-template="<span class='input-group-prepend'><span class='form-group-text'></span></span>{0}"
                                     asp-validation-message-class="text-danger"
                                     asp-refresh-button-class="fas fa-redo btn-sm"
                                     asp-use-noise="false" />
                    </div>
                    <button class="btn btn-primary float-right" type="submit">Verzenden</button>
                    <input id="sm-lat" type="hidden" name="Latitude">
                    <input id="sm-lng" type="hidden" name="Longitude">
                    <button class="btn btn-primary float-right" type="submit">Verzenden</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Maak een melding</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form asp-action="CreateIncident" enctype="multipart/form-data" asp-controller="Incidents" asp-antiforgery="true" method="post">
                    <div class="form-group">
                        <label for="location">Locatie</label>
                        <textarea class="form-control" type="text" name="Location" id="sm-location" readonly></textarea>
                    </div>
                    @{
                        if (Html.ViewContext.HttpContext.Session.GetInt32("LoggedIn") != 1)
                        {
                            <div class="form-group">
                                <label for="img">E-mail</label>
                                <textarea class="form-control" name="Email" id="Email" cols="30" rows="1"></textarea>
                            </div>

                        }
                    }
                    <div class="form-group">
                        <label for="description">Beschrijving</label>
                        <textarea class="form-control" name="Description" id="sm-description" cols="30" rows="9"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="img">Invoer</label>
                        <input class="form-control-file" type="file" name="img" id="img">
                    </div>
                    <div class="input-group mb-3">
                        <dnt-captcha asp-captcha-generator-max="999"
                                     asp-captcha-generator-min="111"
                                     asp-captcha-generator-language="English"
                                     asp-captcha-generator-display-mode="ShowDigits"
                                     asp-use-relative-urls="true"
                                     asp-placeholder="Vul beveiligingscode in."
                                     asp-validation-error-message="Vul de juiste code in."
                                     asp-font-name="Tahoma"
                                     asp-font-size="20"
                                     asp-fore-color="#333333"
                                     asp-back-color="#ccc"
                                     asp-text-box-class="text-box form-control"
                                     asp-text-box-template="<span class='input-group-prepend'><span class='form-group-text'></span></span>{0}"
                                     asp-validation-message-class="text-danger"
                                     asp-refresh-button-class="fas fa-redo btn-sm"
                                     asp-use-noise="false" />
                    </div>
                    <input id="sm-lat" type="hidden" name="lang">
                    <input id="sm-lng" type="hidden" name="lng">
                    <button class="btn btn-primary float-right" type="submit">Verzenden</button>

                </form>
            </div>
        </div>
    </div>
</div>


@section scripts {
    @*TODO: Move javascript*@
    <script>



        let map = L.map('mapid', {
            continuousWorld: true,
            crs: new L.Proj.CRS('EPSG:28992', '+proj=sterea +lat_0=52.15616055555555 +lon_0=5.38763888888889 +k=0.9999079 +x_0=155000 +y_0=463000 +ellps=bessel +units=m +towgs84=565.2369,50.0087,465.658,-0.406857330322398,0.350732676542563,-1.8703473836068,4.0812 +no_defs', { // eslint-disable-line no-undef
                transformation: L.Transformation(-1, -1, 0, 0), // eslint-disable-line no-undef
                resolutions: [3440.640, 1720.320, 860.160, 430.080, 215.040, 107.520, 53.760, 26.880, 13.440, 6.720, 3.360, 1.680, 0.840, 0.420, 0.210, 0.105],
                origin: [-285401.920, 903401.920],
                bounds: L.bounds([-285401.920, 903401.920], [595401.920, 22598.080]) // eslint-disable-line no-undef
            }),
            center: [52.176997, 5.200000],
            @* center: [51.441642, 5.4697225], *@
            zoom: 1
        });
        L.tileLayer('https://geodata.nationaalgeoregister.nl/tiles/service/wmts/brtachtergrondkaart/EPSG:28992/{z}/{x}/{y}.png', {
            minZoom: 3,
            maxZoom: 15,
            zoomOffset: 0,
            tileSize: 256,
            WMTS: false,
            attribution: 'Kaartgegevens &copy; <a href="https://www.kadaster.nl">Kadaster</a>',
        }).addTo(map);
        var popup = L.popup();

        map.on('click', (ev) => {
            let isSMMedia = !window.matchMedia("(min-width: 768px)").matches
            let latlng = map.mouseEventToLatLng(ev.originalEvent);
            @* console.log(latlng.lat + ', ' + latlng.lng); *@
            fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latlng.lat}&lon=${latlng.lng}&format=json`)
                .then((response) => response.json())
                .then(data => {
                    popup.setLatLng(latlng).setContent(data.display_name).openOn(map)
                    if (isSMMedia) {
                        $('#sm-location').val(data.display_name)
                        $('#sm-lat').val(latlng.lat)
                        $('#sm-lng').val(latlng.lng)
                        $('#modal').modal()
                    } else {
                        $('#location').val(data.display_name)
                        $('#lat').val(latlng.lat)
                        $('#lng').val(latlng.lng)
                        @* L.marker(latlng).addTo(map) *@
                        @* console.log(data); alert(data.display_name) *@
                    }
                })
                .catch((error) => console.log(error))
        })

        var request = new Request("/Incidents/Markers");

        var greenIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        var orangeIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        var redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        fetch(request).then(d => d.json()).then(d =>
        {
            for (let i = 0; i < d.length; i++) {


                var popup = '<b>Locatie:</b> ' + d[i].location +
                    '<br><b>Beschrijving:</b> ' + d[i].description;

                var statusColor;

                switch (d[i].status_Id) {
                    case 1:
                        statusColor = redIcon;
                        break;
                    case 2:
                        statusColor = orangeIcon;
                        break;
                    case 3:
                        statusColor = greenIcon;
                        break;
                }


                var layer = L.marker(L.latLng(d[i].latitude, d[i].longitude), { icon: statusColor });
                    layer.bindPopup(popup);
                    layer.addTo(map);


            }

        });

        $(window).on('resize', () => {
            if (!window.matchMedia("(min-width: 768px)").matches) {
                $('#sm-alert').show()
            } else {
                $('#sm-alert').hide()
            }
        })
        
        map.on('locationfound', (e) => {
            var radius = e.accuracy / 2;

            L.marker(e.latlng).addTo(map)
                .bindPopup("U staat binnen" + radius + " meters van dit punt").openPopup();

            L.circle(e.latlng, radius).addTo(map);
        });
        map.locate({setView: true, maxZoom: 16});

    </script>
}
